import SignInPage from '../../page-objects/signin-page';
import NavBarPage from '../../page-objects/navbar-page';

describe('Log In', () => {
  const loginPageTitle = 'login-title';

  beforeEach(() => {
    cy.logout();
    cy.visit('/');
<%_ if (authenticationType === 'oauth2') { _%>
    cy.clearCookies();
    NavBarPage.autoSignOut();
<%_ } _%>
    NavBarPage.getSignInPage();
  });

  it('should fail to login with bad password', () => {
<%_ if (authenticationType !== 'oauth2') { _%>
    SignInPage.getTitle().should('equal', loginPageTitle);
    SignInPage.getUsernameElement().type('admin');
    SignInPage.getPasswordElement().type('foo');

    SignInPage.getLoginButton().click();
    SignInPage.getTitle().should('equal', loginPageTitle);
<%_ } else {_%>
    cy.get('#username').type('admin');
    cy.get('#password').type('foo');
    cy.get('input[type=submit]').click();

    cy.get('.alert-error').then($alert => {
      if ($alert.length) {
        // Keycloak
        expect($alert.get(0).innerText).to.equal('Invalid username or password.');
      } else {
        // Okta
        cy.get('.infobox-error').invoke('text').should('equal', 'Sign in failed!');
      }
    });
<%_ } _%>
  });

  it('should login with admin account', () => {
<%_ if (authenticationType !== 'oauth2') { _%>
    cy.server();
    cy.route('GET', '/api/account').as('authenticationRequest');

    SignInPage.clearUserName();
    SignInPage.setUserName('admin');
    SignInPage.clearPassword();
    SignInPage.setPassword('admin');
    SignInPage.getLoginButton().click();

    cy.wait('@authenticationRequest');

    SignInPage.getTitleElement().should('not.exist');
    NavBarPage.autoSignOut();
<%_ } else {_%>
    // Keycloak credentials by default, change them to be able to use oauth2 with Okta
    cy.get('#username').type('admin');
    cy.get('#password').type('admin');
    cy.get('input[type=submit]').click();

    // Success alert should appear in home page
    cy.get('.alert-success').should('exist');
<%_ } _%>
  });
});

